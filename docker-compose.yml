
version: '3.7'

services:

  broker:
    image: carlop95/gps-mqtt:1.0
    ports:
        - '1883:1883'
    networks:
        - network

  mmm:
    image: carlop95/3m
    ports:
        - '10203:10203/udp'
    networks:
        - network

  object-storage:
    image: 'minio/minio'

    environment:
      MINIO_ACCESS_KEY: "3M-Gps-Chat"
      MINIO_SECRET_KEY: "MMMmmmMMM"
    command: server /data
    networks:
      - network
      
  im:
    image: carlop95/interaction-manager:1.0
    ports:
        - '5683:5683'
    networks:
        - network

  gateway:
    image: kong:1.4.2-alpine
    depends_on:
      - gateway-db
    environment:
      - KONG_DATABASE=postgres
      - KONG_PG_HOST=gateway-db
      - KONG_PG_DATABASE=kong
      - KONG_ADMIN_LISTEN=0.0.0.0:8001, 0.0.0.0:8444 ssl
    ports:
      - 8000:8000
      - 8001:8001
      - 8443:8443
      - 8444:8444 
    networks:
      - network

  gateway-db:
    image: postgres:9.6-alpine
    environment:
      - POSTGRES_USER=kong
      - POSTGRES_DB=kong
    networks:
      - network

  gateway-db-bootstrapper:
    image: kong:1.4.2-alpine
    command: kong migrations bootstrap
    environment:
      - KONG_DATABASE=postgres
      - KONG_PG_HOST=gateway-db
      - KONG_PG_DATABASE=kong
    depends_on:
      - gateway-db
    deploy:
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 2
    networks:
      - network

networks:
  network:
